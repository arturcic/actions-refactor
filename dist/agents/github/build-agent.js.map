{"version":3,"file":"build-agent.js","sources":["../../../src/agents/github/command.ts","../../../src/agents/github/build-agent.ts"],"sourcesContent":["import * as os from 'node:os'\r\nimport * as fs from 'node:fs'\r\nimport crypto from 'node:crypto'\r\n\r\nconst CMD_STRING = '::'\r\n\r\nexport interface CommandProperties {\r\n    [key: string]: string | object\r\n}\r\n\r\n/**\r\n * Commands\r\n *\r\n * Command Format:\r\n *   ::name key=value,key=value::message\r\n *\r\n * Examples:\r\n *   ::warning::This is the message\r\n *   ::set-env name=MY_VAR::some value\r\n */\r\nexport function issueCommand(command: string, properties: CommandProperties, message: string): void {\r\n    const cmd = new Command(command, properties, message)\r\n    process.stdout.write(cmd.toString() + os.EOL)\r\n}\r\n\r\nexport function issueFileCommand(command: string, message: string | object): void {\r\n    const filePath = process.env[`GITHUB_${command}`]\r\n    if (!filePath) {\r\n        throw new Error(`Unable to find environment variable for file command ${command}`)\r\n    }\r\n    if (!fs.existsSync(filePath)) {\r\n        throw new Error(`Missing file at path: ${filePath}`)\r\n    }\r\n\r\n    fs.appendFileSync(filePath, `${toCommandValue(message)}${os.EOL}`, {\r\n        encoding: 'utf8'\r\n    })\r\n}\r\n\r\nexport enum ExitCode {\r\n    /**\r\n     * A code indicating that the action was successful\r\n     */\r\n    Success = 0,\r\n\r\n    /**\r\n     * A code indicating that the action was a failure\r\n     */\r\n    Failure = 1\r\n}\r\n\r\nclass Command {\r\n    private readonly command: string\r\n    private readonly message: string\r\n    private readonly properties: CommandProperties\r\n\r\n    constructor(command: string, properties: CommandProperties, message: string) {\r\n        if (!command) {\r\n            command = 'missing.command'\r\n        }\r\n\r\n        this.command = command\r\n        this.properties = properties\r\n        this.message = message\r\n    }\r\n\r\n    toString(): string {\r\n        let cmdStr = CMD_STRING + this.command\r\n\r\n        if (this.properties && Object.keys(this.properties).length > 0) {\r\n            cmdStr += ' '\r\n            let first = true\r\n            for (const key in this.properties) {\r\n                if (this.properties.hasOwnProperty(key)) {\r\n                    const val = this.properties[key]\r\n                    if (val) {\r\n                        if (first) {\r\n                            first = false\r\n                        } else {\r\n                            cmdStr += ','\r\n                        }\r\n\r\n                        cmdStr += `${key}=${escapeProperty(val)}`\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        cmdStr += `${CMD_STRING}${escapeData(this.message)}`\r\n        return cmdStr\r\n    }\r\n}\r\n\r\nfunction escapeData(s: string | object): string {\r\n    return toCommandValue(s).replace(/%/g, '%25').replace(/\\r/g, '%0D').replace(/\\n/g, '%0A')\r\n}\r\n\r\nfunction escapeProperty(s: string | object): string {\r\n    return toCommandValue(s).replace(/%/g, '%25').replace(/\\r/g, '%0D').replace(/\\n/g, '%0A').replace(/:/g, '%3A').replace(/,/g, '%2C')\r\n}\r\n\r\nexport function toCommandValue(input: string | object): string {\r\n    if (input === null || input === undefined) {\r\n        return ''\r\n    } else if (typeof input === 'string' || input instanceof String) {\r\n        return input as string\r\n    }\r\n    return JSON.stringify(input)\r\n}\r\n\r\nexport function prepareKeyValueMessage(key: string, value: string | object): string {\r\n    const uuid = crypto.randomUUID()\r\n    const delimiter = `ghadelimiter_${uuid}`\r\n    const convertedValue = toCommandValue(value)\r\n\r\n    // These should realistically never happen, but just in case someone finds a\r\n    // way to exploit uuid generation let's not allow keys or values that contain\r\n    // the delimiter.\r\n    if (key.includes(delimiter)) {\r\n        throw new Error(`Unexpected input: name should not contain the delimiter \"${delimiter}\"`)\r\n    }\r\n\r\n    if (convertedValue.includes(delimiter)) {\r\n        throw new Error(`Unexpected input: value should not contain the delimiter \"${delimiter}\"`)\r\n    }\r\n\r\n    return `${key}<<${delimiter}${os.EOL}${convertedValue}${os.EOL}${delimiter}`\r\n}\r\n","import * as os from 'node:os'\r\nimport process from 'node:process'\r\nimport { BuildAgentBase, IBuildAgent } from '@agents/common'\r\nimport { ExitCode, issueCommand, issueFileCommand, prepareKeyValueMessage, toCommandValue } from './command'\r\n\r\nexport class BuildAgent extends BuildAgentBase implements IBuildAgent {\r\n    agentName = 'GitHub Actions'\r\n\r\n    sourceDirVariable = 'GITHUB_WORKSPACE'\r\n    tempDirVariable = 'RUNNER_TEMP'\r\n    cacheDirVariable = 'RUNNER_TOOL_CACHE'\r\n\r\n    addPath(inputPath: string): void {\r\n        super.addPath(inputPath)\r\n        const filePath = process.env['GITHUB_PATH'] || ''\r\n        if (filePath) {\r\n            issueFileCommand('PATH', inputPath)\r\n        } else {\r\n            issueCommand('add-path', {}, inputPath)\r\n        }\r\n    }\r\n\r\n    debug = (message: string): void => issueCommand('debug', {}, message)\r\n\r\n    info = (message: string): void => {\r\n        process.stdout.write(message + os.EOL)\r\n    }\r\n\r\n    warn = (message: string): void => issueCommand('warning', {}, message)\r\n\r\n    error = (message: string): void => issueCommand('error', {}, message)\r\n\r\n    setSucceeded(_message: string, _done?: boolean): void {\r\n        process.exitCode = ExitCode.Success\r\n    }\r\n\r\n    setFailed = (message: string, _: boolean): void => {\r\n        process.exitCode = ExitCode.Failure\r\n        this.error(message)\r\n    }\r\n\r\n    setOutput = (name: string, value: string): void => {\r\n        const filePath = process.env['GITHUB_OUTPUT'] || ''\r\n        if (filePath) {\r\n            return issueFileCommand('OUTPUT', prepareKeyValueMessage(name, value))\r\n        }\r\n\r\n        process.stdout.write(os.EOL)\r\n        issueCommand('set-output', { name }, toCommandValue(value))\r\n    }\r\n\r\n    setVariable = (name: string, value: string): void => {\r\n        const convertedVal = toCommandValue(value)\r\n        process.env[name] = convertedVal\r\n\r\n        const filePath = process.env['GITHUB_ENV'] || ''\r\n        if (filePath) {\r\n            return issueFileCommand('ENV', prepareKeyValueMessage(name, value))\r\n        }\r\n\r\n        issueCommand('set-env', { name }, convertedVal)\r\n    }\r\n}\r\n"],"names":["ExitCode","process"],"mappings":"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"}
{"version":3,"file":"build-agent.js","sources":["../../../src/agents/azure/command.ts","../../../src/agents/azure/build-agent.ts"],"sourcesContent":["import * as process from 'node:process'\r\nimport * as os from 'node:os'\r\n\r\nconst CMD_PREFIX = '##vso['\r\n\r\nexport interface CommandProperties {\r\n    [key: string]: string | object\r\n}\r\n\r\nexport enum TaskResult {\r\n    Succeeded = 0,\r\n    SucceededWithIssues = 1,\r\n    Failed = 2,\r\n    Cancelled = 3,\r\n    Skipped = 4\r\n}\r\n\r\n/**\r\n *  Command Format:\r\n *    ##vso[artifact.command key=value;key=value]user message\r\n *\r\n *  Examples:\r\n *    ##vso[task.progress value=58]\r\n *    ##vso[task.issue type=warning;]This is the user warning message\r\n **/\r\nexport function issueCommand(command: string, properties: CommandProperties, message: string): void {\r\n    const cmd = new Command(command, properties, message)\r\n    process.stdout.write(cmd.toString() + os.EOL)\r\n}\r\n\r\nclass Command {\r\n    private readonly command: string\r\n    private readonly message: string\r\n    private readonly properties: CommandProperties\r\n\r\n    constructor(command: string, properties: CommandProperties, message: string) {\r\n        if (!command) {\r\n            command = 'missing.command'\r\n        }\r\n\r\n        this.command = command\r\n        this.properties = properties\r\n        this.message = message\r\n    }\r\n\r\n    toString(): string {\r\n        let cmdStr = CMD_PREFIX + this.command\r\n\r\n        if (this.properties && Object.keys(this.properties).length > 0) {\r\n            cmdStr += ' '\r\n            for (const key in this.properties) {\r\n                if (this.properties.hasOwnProperty(key)) {\r\n                    const val = this.properties[key]\r\n                    if (val) {\r\n                        // safely append the val - avoid blowing up when attempting to\r\n                        // call .replace() if message is not a string for some reason\r\n                        cmdStr += `${key}=${escapeProperty(`${val || ''}`)};`\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        cmdStr += ']'\r\n\r\n        // safely append the message - avoid blowing up when attempting to\r\n        // call .replace() if message is not a string for some reason\r\n        const message = `${this.message || ''}`\r\n        cmdStr += escapeData(message)\r\n\r\n        return cmdStr\r\n    }\r\n}\r\n\r\nfunction escapeData(s: string | object): string {\r\n    return toCommandValue(s).replace(/%/g, '%AZP25').replace(/\\r/g, '%0D').replace(/\\n/g, '%0A')\r\n}\r\n\r\nfunction escapeProperty(s: string | object): string {\r\n    return toCommandValue(s).replace(/%/g, '%AZP25').replace(/\\r/g, '%0D').replace(/\\n/g, '%0A').replace(/]/g, '%5D').replace(/;/g, '%3B')\r\n}\r\n\r\nfunction toCommandValue(input: string | object): string {\r\n    if (input === null || input === undefined) {\r\n        return ''\r\n    } else if (typeof input === 'string' || input instanceof String) {\r\n        return input as string\r\n    }\r\n    return JSON.stringify(input)\r\n}\r\n","import * as process from 'node:process'\r\nimport { BuildAgentBase, IBuildAgent } from '@agents/common'\r\nimport { issueCommand, TaskResult } from './command'\r\n\r\nexport class BuildAgent extends BuildAgentBase implements IBuildAgent {\r\n    agentName = 'Azure Pipelines'\r\n\r\n    sourceDirVariable = 'BUILD_SOURCESDIRECTORY'\r\n    tempDirVariable = 'AGENT_TEMPDIRECTORY'\r\n    cacheDirVariable = 'AGENT_TOOLSDIRECTORY'\r\n\r\n    addPath(inputPath: string): void {\r\n        super.addPath(inputPath)\r\n        issueCommand('task.prependpath', {}, inputPath)\r\n    }\r\n\r\n    info = (message: string): void => this.debug(message)\r\n\r\n    debug = (message: string): void => issueCommand('task.debug', {}, message)\r\n\r\n    warn = (message: string): void => issueCommand('task.issue', { type: 'warning' }, message)\r\n\r\n    error = (message: string): void => issueCommand('task.issue', { type: 'error' }, message)\r\n\r\n    setSucceeded = (message: string, done?: boolean): void => this._setResult(TaskResult.Succeeded, message, done)\r\n\r\n    setFailed = (message: string, done?: boolean): void => this._setResult(TaskResult.Failed, message, done)\r\n\r\n    setOutput = (name: string, value: string): void => this._setVariable(name, value, true)\r\n\r\n    setVariable = (name: string, value: string): void => this._setVariable(name, value)\r\n\r\n    private _setResult(result: TaskResult, message: string, done?: boolean): void {\r\n        this.debug(`task result: ${TaskResult[result]}`)\r\n        // add an error issue\r\n        if (result === TaskResult.Failed && message) {\r\n            this.error(message)\r\n        } else if (result === TaskResult.SucceededWithIssues && message) {\r\n            this.warn(message)\r\n        }\r\n        // task.complete\r\n        const properties: Record<string, string> = { result: TaskResult[result] }\r\n        if (done) {\r\n            properties['done'] = 'true'\r\n        }\r\n        issueCommand('task.complete', properties, message)\r\n    }\r\n\r\n    private _setVariable(name: string, val: string, isOutput = false): void {\r\n        const key: string = this._getVariableKey(name)\r\n        const varValue = val || ''\r\n        process.env[key] = varValue\r\n\r\n        issueCommand(\r\n            'task.setvariable',\r\n            {\r\n                variable: name || '',\r\n                isOutput: (isOutput || false).toString(),\r\n                issecret: 'false'\r\n            },\r\n            varValue\r\n        )\r\n    }\r\n\r\n    private _getVariableKey(name: string): string {\r\n        return name.replace(/\\./g, '_').replace(/ /g, '_').toUpperCase()\r\n    }\r\n}\r\n"],"names":["TaskResult"],"mappings":"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"}